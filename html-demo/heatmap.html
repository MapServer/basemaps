<html>
<head>
    <link rel="stylesheet" href="js/lib/jquery/jquery-ui-1.10.3.custom.min.css"/>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.2/dist/leaflet.css"/>
    <link rel="stylesheet" href="js/leaflet.zoomdisplay.css"/>
    <link rel="stylesheet" href="js/leaflet.rasterctrl.css"/>
    <link rel="stylesheet" href="js/Leaflet.Coordinates.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-easybutton@2.0.0/src/easy-button.css">
    <link rel="stylesheet" href="js/lib/opacity/Control.Opacity.css"/>

    <script src="https://code.jquery.com/jquery-3.1.1.slim.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.0.2/dist/leaflet.js"></script>
    <script src="js/leaflet.wms.js"></script>
    <script src="js/TileLayer.Grayscale.js"></script>
    <script src="js/leaflet.zoomdisplay-src.js"></script>
    <script src="js/Leaflet.Coordinates.js"></script>
    <script src="js/leaflet.rasterctrl-src.js"></script>
    <script src="js/leaflet-heat.js"></script>
    <script src="https://unpkg.com/leaflet-easybutton@2.0.0/src/easy-button.js"></script>

    <script src="js/lib/opacity/Control.Opacity.js"></script>
    <script src="js/lib/jquery/jquery-1.9.1.js"></script>
    <script src="js/lib/jquery/jquery-ui-1.10.3.custom.min.js"></script>
    <script src="http://malsup.github.com/jquery.form.js"></script>

    <!--todo: json from WS-->
    <!--<script src="data/points.json"></script>-->
    <script src="data/prices_json.js"></script>
    <style>
        #mapid {
            height: 100%;
            width: 100%;
        }

        .leaflet-tile-border {
            border: solid black 1px;
        }

        .img-trans {
            opacity: 0.5;
            display: inline-block;
        }

        input:disabled {
            background: #dddddd;
        }
    </style>

    <script>
        $(document).ready(function () {
            var presets = {
                preset1: {
                    method: "invdist",
                    ramp: [
                        [251, "#c63640"],
                        [224, "#fbff80"],
                        [122, "#c63640"],
                        [255, "#c63640"],
                        [403, "#c63640"]
                    ],
                },
                preset2: {},
            };

            var options = {
                //            target: '#divToUpdate',
                url: 'php/runraster.php',
                success: function (responseText, statusText, xhr, $form) {
                    console.log(responseText);
                    rasterObsLayer.setParams({ts: Date.now()}).redraw();
                },
                error: function (responseText, statusText, xhr, $form) {
                    alert('status: ' + statusText + '\n\nresponseText: \n' + responseText +
                        '\n\nThe output div should have already been updated with the responseText.');
                }
            };

            $('#form1').ajaxForm(options);

            $.ajax({
                type: "GET",
                dataType: "json",
                url: "php/readramp.php", //Relative or absolute path to response.php file
                success: function (effGgdalRamp) {
                    // sets ramp values
                    for (var i = 0; i < effGgdalRamp.length; i++) {
                        if ((effGgdalRamp[i][0].length > 0)) {
                            $('#rval' + (i+1)).val(effGgdalRamp[i][0]);
                            $('#clr' +(i+1)).val(effGgdalRamp[i][1]);
                        }
                    }
                },
                error: function (data) {
                    console.dir(data.responseText);
                }
            });

            // disable ui according to method:
            $('#selmethod').change(function() {
               if ($( "select option:selected" ).val() == 'linear') {
                   $( "#radius1" ).prop( "disabled", false );
                   $( "#power" ).prop( "disabled", true );
                   $( "#smoothing" ).prop( "disabled", true );
                   $( "#radius2" ).prop( "disabled", true );
                   $( "#angle" ).prop( "disabled", true );
               } else if ($( "select option:selected" ).val() == 'invdist') {
                   $( "#power" ).prop( "disabled", false );
                   $( "#smoothing" ).prop( "disabled", false );
                   $( "#radius1" ).prop( "disabled", false );
                   $( "#radius2" ).prop( "disabled", false );
                   $( "#angle" ).prop( "disabled", false );
               } else if ($( "select option:selected" ).val() == 'invdistnn') {
                   $( "#power" ).prop( "disabled", false );
                   $( "#radius1" ).prop( "disabled", false );
                   $( "#smoothing" ).prop( "disabled", true );
                   $( "#radius2" ).prop( "disabled", true );
                   $( "#angle" ).prop( "disabled", true );
               } else if ($( "select option:selected" ).val() == 'average') {
                   $( "#radius1" ).prop( "disabled", false );
                   $( "#radius2" ).prop( "disabled", false );
                   $( "#angle" ).prop( "disabled", false );
                   $( "#power" ).prop( "disabled", true );
                   $( "#smoothing" ).prop( "disabled", true );
               } else if ($( "select option:selected" ).val() == 'nearest') {
                   $( "#radius1" ).prop( "disabled", false );
                   $( "#radius2" ).prop( "disabled", false );
                   $( "#angle" ).prop( "disabled", false );
                   $( "#power" ).prop( "disabled", true );
                   $( "#smoothing" ).prop( "disabled", true );
               } else {

               }
            });

        });
    </script>
</head>
<body>
<div id="mapid"></div>
<script language="JavaScript">
    var vecStyle = {
        fillColor: "#FF0000",
        weight: 2,
        opacity: 0.5,
        color: '#000000'
    };

    var url = '';
    //platform-dependend url
    jQuery.ajaxSetup({async:false});
    var os = jQuery.get('php/os.php');
    os = os.responseText;
    jQuery.ajaxSetup({async:true});

    if (os === "Darwin") {
        var url = '/cgi-bin/mapserv?map=/Users/nicolas/bin/mapserver-basemaps/';
    } else if (os === "Linux") {
        var url = '/cgi-bin/mapserv?map=/home/ubuntu/apps/mapserver-basemaps/';
    }

    var urlMapcache = '/mapcache-osm/tms/1.0.0/[LAYER]@GoogleMapsCompatible/{z}/{x}/{y}.png';
    var urlS3 = 'http://efficity-basemap.s3.amazonaws.com/mapcache/[LAYER]/GoogleMapsCompatible/{z}/{x}/{y}.png';

    var map = L.map('mapid').setView(
        [48.4248, 2.6937], 12
    );

    ////////////// OSM live TMS ////////////////////////////////////////////////////////////////////////////////////////
    //    var osmLayer = L.tileLayer('http://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    //        maxZoom: 18,
    //        'errorTileUrl': 'tileerror.png',
    //        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    //    });

    var googleNoLabelsMapcacheLayer = new L.TileLayer.Grayscale(urlS3.replace('[LAYER]', 'osm_google_no_labels_ts'), {
        'tms': true,
        'errorTileUrl': 'tileerror.png',
        attribution: "&copy; <a href='http://www.efficity.com'>Efficity</a> based on OSM data",
    });

    // heatmap:
    //TODO: data from WS
    var heatmapStreetLayer = L.heatLayer(price_points, {
        radius: 25,
//        maxZoom: 17
    });

    // raster:
    //TODO: data from WS
    var rasterObsLayer = L.tileLayer.wms(url + "raster.map", {
        layers: 'price',
        format: 'image/png',
        transparent: true,
        'errorTileUrl': 'tileerror.png',
        attribution: "Efficity Prices",
        opacity: 0.5
    }).addTo(map);

    // obs point
    var pointLayer = L.tileLayer.wms(url + "raster.map", {
        layers: 'obs_pts',
        format: 'image/png',
        transparent: true,
        'errorTileUrl': 'tileerror.png',
        attribution: "Efficity Prices"
    }).addTo(map);

    // obs point lables
    var pointLblLayer = L.tileLayer.wms(url + "raster.map", {
        layers: 'obs_pts_lbl',
        format: 'image/png',
        transparent: true,
        'errorTileUrl': 'tileerror.png',
        attribution: "Efficity Prices"
    });

    // streets
    var streetLayer = L.tileLayer.wms(url + "raster.map", {
        layers: 'default',
        format: 'image/png',
        transparent: true,
        'errorTileUrl': 'tileerror.png',
        attribution: "Efficity Prices"
    }).addTo(map);


    //    var emptyLayer = L.tileLayer('').addTo(map);
    var emptyLayer = L.tileLayer('').addTo(map);
    var baseLayers = {
        "OSM b&w ": googleNoLabelsMapcacheLayer,
        'empty': emptyLayer
    };
    var overlays = {
        "HeatMap Leaflet": heatmapStreetLayer,
        "GDAL raster": rasterObsLayer,
        "Streets": streetLayer,
        "Observations": pointLayer,
        "Observations prices": pointLblLayer,
    };

    L.control.layers(baseLayers, overlays).addTo(map);

    // coordinates:
    L.control.coordinates().addTo(map);

    //custom button
    L.easyButton('<img id="imggrid" class="img-trans" width="18" height="18" src="image/grid.png">', function (btn, map) {
        $('.leaflet-tile').toggleClass('leaflet-tile-border');
        $('#imggrid').toggleClass('img-trans');
    }).addTo(map);

    var opacitySlider = new L.Control.opacitySlider();
    opacitySlider.setOpacityLayer(rasterObsLayer);
    map.addControl(opacitySlider);

    //    heatmapStreetLayer.redraw();

</script>
</body>
</html>

<!--http://localhost/basemap/php/runraster.php?method=invdist&smoothing=0&rval1=213&clr1=%232e9a58&rval2=250&clr2=%23b8ff85&rval3=300&clr3=%23f2ff0d&rval4=350&clr4=%23ffab4c&rval5=403&clr5=%23ff0000-->