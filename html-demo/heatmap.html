<html>
<head>
    <link rel="stylesheet" href="js/lib/jquery/jquery-ui-1.10.3.custom.min.css"/>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.2/dist/leaflet.css"/>
    <link rel="stylesheet" href="js/leaflet.zoomdisplay.css"/>
    <link rel="stylesheet" href="js/leaflet.rasterctrl.css"/>
    <link rel="stylesheet" href="js/Leaflet.Coordinates.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-easybutton@2.0.0/src/easy-button.css">
    <link rel="stylesheet" href="js/lib/opacity/Control.Opacity.css"/>

    <script src="https://code.jquery.com/jquery-3.1.1.slim.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.0.2/dist/leaflet.js"></script>
    <script src="js/leaflet.wms.js"></script>
    <script src="js/TileLayer.Grayscale.js"></script>
    <script src="js/leaflet.zoomdisplay-src.js"></script>
    <script src="js/Leaflet.Coordinates.js"></script>
    <script src="js/leaflet.rasterctrl-src.js"></script>
    <script src="js/leaflet-heat.js"></script>
    <script src="js/leaflet.mask.effi.js"></script>
    <script src="https://unpkg.com/leaflet-easybutton@2.0.0/src/easy-button.js"></script>

    <script src="js/lib/opacity/Control.Opacity.js"></script>
    <script src="js/lib/jquery/jquery-1.9.1.js"></script>
    <script src="js/lib/jquery/jquery-ui-1.10.3.custom.min.js"></script>
    <script src="http://malsup.github.com/jquery.form.js"></script>

    <!--todo: json from WS-->
    <!--<script src="data/points.json"></script>-->
    <script src="data/prices_json.js"></script>
    <script src="data/zone_93048_json.js"></script>
    <style>
        #mapid {
            height: 100%;
            width: 100%;
        }

        .leaflet-tile-border {
            border: solid black 1px;
        }

        .img-trans {
            opacity: 0.5;
            display: inline-block;
        }

        input:disabled {
            background: #dddddd;
        }
    </style>

    <script>
        //zones confs
        var rasterconf = null;

        function RGB2Color(r,g,b) {
            return '#' + this.byte2Hex(r) + this.byte2Hex(g) + this.byte2Hex(b);
        }
        function byte2Hex (n) {
            var nybHexString = "0123456789ABCDEF";
            return String(nybHexString.substr((n >> 4) & 0x0F,1)) + nybHexString.substr(n & 0x0F,1);
        }

        function setVals(defconf) {
            $('#selmethod').val(defconf.method).trigger('change');
            $('#power').val(defconf.power);
            $('#smoothing').val(defconf.smoothing);
            $('#radius1').val(defconf.radius1);
            $('#radius2').val(defconf.radius2);
            $('#angle').val(defconf.angle);
            for (var i = 0; i < defconf.ramp.length; i++) {
                $('#rval' + (i + 1)).val(defconf.ramp[i][0]);
                // rgb to hex
                var col = RGB2Color(defconf.ramp[i][1], defconf.ramp[i][2], defconf.ramp[i][3]);
                $('#clr' + (i + 1)).val(col);
            }

            map.setView(defconf.latlong, defconf.zoom);
        }

        $(document).ready(function () {
            // disable ui according to method:
            $('#selmethod').change(function() {
                if ($( "#selmethod option:selected" ).val() == 'linear') {
                    $( "#radius1" ).prop( "disabled", false );
                    $( "#power" ).prop( "disabled", true );
                    $( "#smoothing" ).prop( "disabled", true );
                    $( "#radius2" ).prop( "disabled", true );
                    $( "#angle" ).prop( "disabled", true );
                } else if ($( "#selmethod option:selected" ).val() == 'invdist') {
                    $( "#power" ).prop( "disabled", false );
                    $( "#smoothing" ).prop( "disabled", false );
                    $( "#radius1" ).prop( "disabled", false );
                    $( "#radius2" ).prop( "disabled", false );
                    $( "#angle" ).prop( "disabled", false );
                } else if ($( "#selmethod option:selected" ).val() == 'invdistnn') {
                    $( "#power" ).prop( "disabled", false );
                    $( "#radius1" ).prop( "disabled", false );
                    $( "#smoothing" ).prop( "disabled", true );
                    $( "#radius2" ).prop( "disabled", true );
                    $( "#angle" ).prop( "disabled", true );
                } else if ($( "#selmethod option:selected" ).val() == 'average') {
                    $( "#radius1" ).prop( "disabled", false );
                    $( "#radius2" ).prop( "disabled", false );
                    $( "#angle" ).prop( "disabled", false );
                    $( "#power" ).prop( "disabled", true );
                    $( "#smoothing" ).prop( "disabled", true );
                } else if ($( "#selmethod option:selected" ).val() == 'nearest') {
                    $( "#radius1" ).prop( "disabled", false );
                    $( "#radius2" ).prop( "disabled", false );
                    $( "#angle" ).prop( "disabled", false );
                    $( "#power" ).prop( "disabled", true );
                    $( "#smoothing" ).prop( "disabled", true );
                } else {

                }
            });

            // change on zone: reload good conf
            $('#selzone').change(function() {
                var zone = $( "#selzone option:selected" ).val();
                setVals(rasterconf[zone]);
                // relaunch raster

                // zoom to zone
                map.setView(rasterconf[zone].latlong, rasterconf[zone].zoom);
            });

            // gets conf and initialize list
            $.ajax({
                type: "GET",
                dataType: "json",
                url: "php/conf.php", //Relative or absolute path to response.php file
                success: function (conf) {
                    // sets ramp values
                    rasterconf = conf;
                    var options = $("#selzone");
                    for (var property in conf) {
                        if (conf.hasOwnProperty(property)) {
                            // do stuff
                            var sel = conf[property].default;
                            options.append($("<option />").val(property).text(property).prop('selected', sel));

                            // color ramp from default value:
                            if (sel) {
                                setVals(conf[property]);
                            }

                        }
                    }
                },
                error: function (data) {
                    console.dir(data.responseText);
                }
            });


            var options = {
                //            target: '#divToUpdate',
                url: 'php/runraster.php',
                success: function (responseText, statusText, xhr, $form) {
                    console.log(responseText);
                    $('#waitmsg').toggle();
                    raster1ObsLayer.setParams({ts: Date.now()}).redraw();
                    raster2ObsLayer.setParams({ts: Date.now()}).redraw();
                    raster3ObsLayer.setParams({ts: Date.now()}).redraw();
                },
                error: function (responseText, statusText, xhr, $form) {
                    alert('status: ' + statusText + '\n\nresponseText: \n' + responseText +
                        '\n\nThe output div should have already been updated with the responseText.');
                }
            };

            $('#form1').ajaxForm(options);

//            $.ajax({
//                type: "GET",
//                dataType: "json",
//                url: "php/readramp.php", //Relative or absolute path to response.php file
//                success: function (effGgdalRamp) {
//                    // sets ramp values
//                    for (var i = 0; i < effGgdalRamp.length; i++) {
//                        if ((effGgdalRamp[i][0].length > 0)) {
//                            $('#rval' + (i+1)).val(effGgdalRamp[i][0]);
//                            $('#clr' +(i+1)).val(effGgdalRamp[i][1]);
//                        }
//                    }
//                },
//                error: function (data) {
//                    console.dir(data.responseText);
//                }
//            });
            // wait msg
            $('#submitbtn').on('click', function(){
                $('#waitmsg').toggle();
            });

            // dots anime
            var dots = window.setInterval( function() {
                var wait = document.getElementById("dots");
                if ( wait.innerHTML.length > 4 )
                    wait.innerHTML = "";
                else
                    wait.innerHTML += " &#8226;";
            }, 333);

            // toggles slope ramp by default
            $('#waitmsg').toggle();

            $('#clrrangeSlider').on('input', function (ev) {
                raster1ObsLayer.setOpacity(this.value/100);
            });


        });
    </script>
</head>
<body>
<div id="mapid"></div>
<script language="JavaScript">
    var vecStyle = {
        fillColor: "#FF0000",
        weight: 2,
        opacity: 0.5,
        color: '#000000'
    };

    var url = '';
    //platform-dependend url
    jQuery.ajaxSetup({async:false});
    var os = jQuery.get('php/os.php');
    os = os.responseText;
    jQuery.ajaxSetup({async:true});

    if (os === "Darwin") {
        var url = '/cgi-bin/mapserv?map=/Users/nicolas/bin/mapserver-basemaps/';
    } else if (os === "Linux") {
        var url = '/cgi-bin/mapserv?map=/home/ubuntu/apps/mapserver-basemaps/';
    }

    var urlMapcache = '/mapcache-osm/tms/1.0.0/[LAYER]@GoogleMapsCompatible/{z}/{x}/{y}.png';
    var urlS3 = 'http://efficity-basemap.s3.amazonaws.com/mapcache/[LAYER]/GoogleMapsCompatible/{z}/{x}/{y}.png';

    var map = L.map('mapid').setView(
        [48.863, 2.4477], 14
    );

    ////////////// OSM live TMS ////////////////////////////////////////////////////////////////////////////////////////
    //    var osmLayer = L.tileLayer('http://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    //        maxZoom: 18,
    //        'errorTileUrl': 'image/tileerror.png',
    //        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    //    });

    var googleNoLabelsMapcacheLayer = new L.TileLayer.Grayscale(urlS3.replace('[LAYER]', 'osm_google_no_labels_ts'), {
        'tms': true,
        'errorTileUrl': 'image/tileerror.png',
        attribution: "&copy; <a href='http://www.efficity.com'>Efficity</a> based on OSM data",
    });

    // heatmap:
    //TODO: data from WS
    var heatmapStreetLayer = L.heatLayer(price_points, {
        radius: 25,
//        maxZoom: 17
    });

    // raster:
    //TODO: data from WS
    var raster1ObsLayer = L.tileLayer.wms(url + "raster.map", {
        layers: 'price_93048',
        format: 'image/png',
        transparent: true,
        'errorTileUrl': 'image/tileerror.png',
        attribution: "Efficity Prices",
        opacity: 0.75
    }).addTo(map);

    var raster2ObsLayer = L.tileLayer.wms(url + "raster.map", {
        layers: 'price_06088',
        format: 'image/png',
        transparent: true,
        'errorTileUrl': 'image/tileerror.png',
        attribution: "Efficity Prices",
        opacity: 0.5
    }).addTo(map);

    var raster3ObsLayer = L.tileLayer.wms(url + "raster.map", {
        layers: 'price_35051',
        format: 'image/png',
        transparent: true,
        'errorTileUrl': 'image/tileerror.png',
        attribution: "Efficity Prices",
        opacity: 0.5
    }).addTo(map);

    // obs point
    var pointLayer = L.tileLayer.wms(url + "raster.map", {
        layers: 'obs_pts',
        format: 'image/png',
        transparent: true,
        'errorTileUrl': 'image/tileerror.png',
        attribution: "Efficity Prices"
    });

    // obs point lables
    var pointLblLayer = L.tileLayer.wms(url + "raster.map", {
        layers: 'obs_pts_lbl',
        format: 'image/png',
        transparent: true,
        'errorTileUrl': 'image/tileerror.png',
        attribution: "Efficity Prices"
    });

    // streets
    var streetLayer = L.tileLayer.wms(url + "raster.map", {
        layers: 'default',
        format: 'image/png',
        transparent: true,
        'errorTileUrl': 'image/tileerror.png',
        attribution: "Efficity Prices"
    });

//    commune mask
    L.mask(zone_93048).addTo(map);


    //    var emptyLayer = L.tileLayer('').addTo(map);
    var emptyLayer = L.tileLayer('').addTo(map);
    var baseLayers = {
        "OSM b&w ": googleNoLabelsMapcacheLayer,
        'empty': emptyLayer
    };
    var overlays = {
        "HeatMap Leaflet": heatmapStreetLayer,
        "GDAL raster 93048": raster1ObsLayer,
        "GDAL raster 06088": raster2ObsLayer,
        "GDAL raster 35051": raster3ObsLayer,
        "Streets": streetLayer,
        "Observations": pointLayer,
        "Observations prices": pointLblLayer,
    };

    L.control.layers(baseLayers, overlays).addTo(map);

    // coordinates:
    L.control.coordinates().addTo(map);

    //custom button
    L.easyButton('<img id="imggrid" class="img-trans" width="18" height="18" src="image/grid.png">', function (btn, map) {
        $('.leaflet-tile').toggleClass('leaflet-tile-border');
        $('#imggrid').toggleClass('img-trans');
    }).addTo(map);

    //    heatmapStreetLayer.redraw();

</script>
</body>
</html>

<!--http://localhost/basemap/php/runraster.php?method=invdist&smoothing=0&rval1=213&clr1=%232e9a58&rval2=250&clr2=%23b8ff85&rval3=300&clr3=%23f2ff0d&rval4=350&clr4=%23ffab4c&rval5=403&clr5=%23ff0000-->