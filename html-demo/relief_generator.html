<html>
<head>
    <link rel="stylesheet" href="js/lib/jquery/jquery-ui-1.10.3.custom.min.css"/>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.2/dist/leaflet.css"/>
    <link rel="stylesheet" href="js/leaflet.zoomdisplay.css"/>
    <link rel="stylesheet" href="js/leaflet.reliefctrl.css"/>
    <link rel="stylesheet" href="js/Leaflet.Coordinates.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-easybutton@2.0.0/src/easy-button.css">
    <link rel="stylesheet" href="js/lib/opacity/Control.Opacity.css"/>

    <script src="https://code.jquery.com/jquery-3.1.1.slim.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.0.2/dist/leaflet.js"></script>
    <script src="js/leaflet.wms.js"></script>
    <script src="js/TileLayer.Grayscale.js"></script>
    <script src="js/leaflet.zoomdisplay-src.js"></script>
    <script src="js/Leaflet.Coordinates.js"></script>
    <script src="js/leaflet.reliefctrl-src.js"></script>
    <script src="js/leaflet-heat.js"></script>
    <script src="https://unpkg.com/leaflet-easybutton@2.0.0/src/easy-button.js"></script>

    <script src="js/lib/opacity/Control.Opacity.js"></script>
    <script src="js/lib/jquery/jquery-1.9.1.js"></script>
    <script src="js/lib/jquery/jquery-ui-1.10.3.custom.min.js"></script>
    <script src="http://malsup.github.com/jquery.form.js"></script>

    <!--todo: json from WS-->
    <!--<script src="data/points.json"></script>-->
    <script src="data/prices_json.js"></script>
    <style>
        #mapid {
            height: 100%;
            width: 100%;
        }

        .leaflet-tile-border {
            border: solid black 1px;
        }

        .img-trans {
            opacity: 0.5;
            display: inline-block;
        }

        input:disabled {
            background: #dddddd;
        }

        .normala {
            display: inline!important;
            color: #0055ff!important;
            height: 12px!important;
            line-height: 15px!important;
        }

        .deminfo {
            font-weight: bold;
        }

    </style>

    <script>
        var rasterramps = '';

        function setClrRamp(ramp) {
            var clrs = rasterramps[ramp];
            for (var i = 0; i < clrs.length; i++) {
                $('#clr' + (i + 1)).val(RGB2Color(clrs[i][0], clrs[i][1], clrs[i][2]));
            }
        }

        function RGB2Color(r,g,b) {
            return '#' + this.byte2Hex(r) + this.byte2Hex(g) + this.byte2Hex(b);
        }
        function byte2Hex (n) {
            var nybHexString = "0123456789ABCDEF";
            return String(nybHexString.substr((n >> 4) & 0x0F,1)) + nybHexString.substr(n & 0x0F,1);
        }

        $(document).ready(function () {
            // gets ramps config: // TODO: getjson()
            $.ajax({
                type: "GET",
                dataType: "json",
                url: "php/ramps.php",
                success: function (data) {
                    rasterramps = data;
                }
            });

            // gets raster info: // TODO: getjson()
            $.ajax({
                type: "GET",
                dataType: "json",
                url: "php/rasterinfo.php",
                success: function (demInfo) {
                    $('#demmin').html(demInfo["min"]);
                    $('#demmax').html(demInfo["max"]);
                    $('#demavg').html(demInfo["avg"]);
                },
                error: function (data) {
                    console.dir(data.responseText);
                }
            });

            var options = {
                //            target: '#divToUpdate',
                url: 'php/runrelief.php',
                success: function (responseText, statusText, xhr, $form) {
                    console.log(responseText);
                    $('#waitmsg').toggle();
                    colorReliefLayer.setParams({ts: Date.now()}).redraw();
                    hillshadeLayer.setParams({ts: Date.now()}).redraw();
                    slopeShadeLayer.setParams({ts: Date.now()}).redraw();
                },
                error: function (responseText, statusText, xhr, $form) {
                    alert('status: ' + statusText + '\n\nresponseText: \n' + responseText +
                        '\n\nThe output div should have already been updated with the responseText.');
                }
            };

            $('#form1').ajaxForm(options);

            $.ajax({
                type: "GET",
                dataType: "json",
                url: "php/readrelieframp.php", //Relative or absolute path to response.php file
                success: function (effGgdalRamp) {
                    // sets ramp values
                    for (var i = 0; i < effGgdalRamp.length; i++) {
                        if ((effGgdalRamp[i][0].length > 0)) {
                            $('#rval' + (i + 1)).val(effGgdalRamp[i][0]);
                            $('#clr' + (i + 1)).val(effGgdalRamp[i][1]);
                        }
                    }
                },
                error: function (data) {
                    console.dir(data.responseText);
                }
            });

            // disable ui according to method:
            $('#selmethod').change(function () {
                if ($("select option:selected").val() == 'linear') {
                    $("#radius1").prop("disabled", false);
                    $("#power").prop("disabled", true);
                    $("#smoothing").prop("disabled", true);
                    $("#radius2").prop("disabled", true);
                    $("#angle").prop("disabled", true);
                } else if ($("select option:selected").val() == 'invdist') {
                    $("#power").prop("disabled", false);
                    $("#smoothing").prop("disabled", false);
                    $("#radius1").prop("disabled", false);
                    $("#radius2").prop("disabled", false);
                    $("#angle").prop("disabled", false);
                } else if ($("select option:selected").val() == 'invdistnn') {
                    $("#power").prop("disabled", false);
                    $("#radius1").prop("disabled", false);
                    $("#smoothing").prop("disabled", true);
                    $("#radius2").prop("disabled", true);
                    $("#angle").prop("disabled", true);
                } else if ($("select option:selected").val() == 'average') {
                    $("#radius1").prop("disabled", false);
                    $("#radius2").prop("disabled", false);
                    $("#angle").prop("disabled", false);
                    $("#power").prop("disabled", true);
                    $("#smoothing").prop("disabled", true);
                } else if ($("select option:selected").val() == 'nearest') {
                    $("#radius1").prop("disabled", false);
                    $("#radius2").prop("disabled", false);
                    $("#angle").prop("disabled", false);
                    $("#power").prop("disabled", true);
                    $("#smoothing").prop("disabled", true);
                } else {

                }
            });

            // tooltips for ramps
            $( "#clrramp1" ).tooltip({ content: '<img src="image/clrramp1.png" />' });
            $( "#clrramp2" ).tooltip({ content: '<img src="image/clrramp2.png" />' });
            $( "#clrramp3" ).tooltip({ content: '<img src="image/clrramp3.png" />' });
            $( "#clrramp4" ).tooltip({ content: '<img src="image/clrramp4.png" />' });
            $( "#clrramp5" ).tooltip({ content: '<img src="image/clrramp5.png" />' });
            $( "#clrramp6" ).tooltip({ content: '<img src="image/clrramp6.png" />' });
            $( "#clrramp7" ).tooltip({ content: '<img src="image/clrramp7.png" />' });
            $( "#clrramp8" ).tooltip({ content: '<img src="image/clrramp8.png" />' });

            // click event for ramp: fills up the current ramp
            // TODO...
            $('#clrramp1').on('click', function(){
                setClrRamp('ramp1');
            });
            $('#clrramp2').on('click', function(){
                setClrRamp('ramp2');
            });
            $('#clrramp3').on('click', function(){
                setClrRamp('ramp3');
            });
            $('#clrramp4').on('click', function(){
                setClrRamp('ramp4');
            });
            $('#clrramp5').on('click', function(){
                setClrRamp('ramp5');
            });
            $('#clrramp6').on('click', function(){
                setClrRamp('ramp6');
            });
            $('#clrramp7').on('click', function(){
                setClrRamp('ramp7');
            });
            $('#clrramp8').on('click', function(){
                setClrRamp('ramp8');
            });


            $('#sloperamplnk').on('click', function(){
                $('#sloperampdiv').toggle();
            });

            // wait msg
            $('#submitbtn').on('click', function(){
                $('#waitmsg').toggle();
            });

            // dots anime
            var dots = window.setInterval( function() {
                var wait = document.getElementById("dots");
                if ( wait.innerHTML.length > 4 )
                    wait.innerHTML = "";
                else
                    wait.innerHTML += " &#8226;";
            }, 333);

            // toggles slope ramp by default
            $('#sloperampdiv').toggle();
            $('#waitmsg').toggle();

            //opacity sliders:
            $('#clrrangeSlider').on('input', function (ev) {
                colorReliefLayer.setOpacity(this.value/100);
            });
            $('#sloperangeSlider').on('input', function (ev) {
                slopeShadeLayer.setOpacity(this.value/100);
            });
            $('#hillrangeSlider').on('input', function (ev) {
                hillshadeLayer.setOpacity(this.value/100);
            });

        });
    </script>
</head>
<body>
<div id="mapid"></div>
<script language="JavaScript">
    var vecStyle = {
        fillColor: "#FF0000",
        weight: 2,
        opacity: 0.5,
        color: '#000000'
    };

    var url = '';
    //platform-dependend url
    jQuery.ajaxSetup({async: false});
    var os = jQuery.get('php/os.php');
    os = os.responseText;
    jQuery.ajaxSetup({async: true});

    if (os === "Darwin") {
        var url = '/cgi-bin/mapserv?map=/Users/nicolas/bin/mapserver-basemaps/';
    } else if (os === "Linux") {
        var url = '/cgi-bin/mapserv?map=/home/ubuntu/apps/mapserver-basemaps/';
    }

    var urlMapcache = '/mapcache-osm/tms/1.0.0/[LAYER]@GoogleMapsCompatible/{z}/{x}/{y}.png';
    var urlS3 = 'http://efficity-basemap.s3.amazonaws.com/mapcache/[LAYER]/GoogleMapsCompatible/{z}/{x}/{y}.png';

    var map = L.map('mapid').setView(
        [46.8, 3.07], 6
    );

    ////////////// OSM live TMS ////////////////////////////////////////////////////////////////////////////////////////
    //    var osmLayer = L.tileLayer('http://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    //        maxZoom: 18,
    //        'errorTileUrl': 'tileerror.png',
    //        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    //    });

    var googleNoLabelsMapcacheLayer = new L.TileLayer.Grayscale(urlS3.replace('[LAYER]', 'osm_google_no_labels_ts'), {
        'tms': true,
        'errorTileUrl': 'tileerror.png',
        attribution: "&copy; <a href='http://www.efficity.com'>Efficity</a> based on OSM data",
    });

    // 3 DEM parts to produce nice terrain:
    // color relief
    var colorReliefLayer = L.tileLayer.wms(url + "relief.map", {
        layers: 'color_relief',
        format: 'image/png',
        transparent: true,
        'errorTileUrl': 'tileerror.png',
        attribution: "© 2017. Nicolas Ribot",
        opacity: 0.5
    }).addTo(map);

    // hillshade
    var hillshadeLayer = L.tileLayer.wms(url + "relief.map", {
        layers: 'hillshade',
        format: 'image/png',
        transparent: true,
        'errorTileUrl': 'tileerror.png',
        attribution: "© 2017. Nicolas Ribot",
        opacity: 0.5
    }).addTo(map);

    var slopeShadeLayer = L.tileLayer.wms(url + "relief.map", {
        layers: 'slopeshade',
        format: 'image/png',
        transparent: true,
        'errorTileUrl': 'tileerror.png',
        attribution: "© 2017. Nicolas Ribot",
        opacity: 0.5
    }).addTo(map);

    // streets
    var streetLayer = L.tileLayer.wms(url + "relief.map", {
        layers: 'default',
        format: 'image/png',
        transparent: true,
        'errorTileUrl': 'tileerror.png',
        attribution: "© 2017. Nicolas Ribot",
    }).addTo(map);


    //    var emptyLayer = L.tileLayer('').addTo(map);
    var emptyLayer = L.tileLayer('').addTo(map);
    var baseLayers = {
        "OSM b&w ": googleNoLabelsMapcacheLayer,
        'empty': emptyLayer
    };
    var overlays = {
        "Color Relief": colorReliefLayer,
        "Hillshade": hillshadeLayer,
        "Slopeshade": slopeShadeLayer,
        "Streets": streetLayer
    };

    L.control.layers(baseLayers, overlays).addTo(map);

    // coordinates:
    L.control.coordinates().addTo(map);

    //custom button
    L.easyButton('<img id="imggrid" class="img-trans" width="18" height="18" src="image/grid.png">', function (btn, map) {
        $('.leaflet-tile').toggleClass('leaflet-tile-border');
        $('#imggrid').toggleClass('img-trans');
    }).addTo(map);

//    var opacitySlider2 = new L.Control.opacitySlider();
//    opacitySlider2.setOpacityLayer(hillshadeLayer);
//    map.addControl(opacitySlider2);
//
//    var opacitySlider3 = new L.Control.opacitySlider();
//    opacitySlider3.setOpacityLayer(slopeShadeLayer);
//    map.addControl(opacitySlider3);
//
//    var opacitySlider = new L.Control.opacitySlider();
//    opacitySlider.setOpacityLayer(colorReliefLayer);
//    map.addControl(opacitySlider);

    //    heatmapStreetLayer.redraw();

</script>
</body>
</html>

<!--http://localhost/basemap/php/runraster.php?method=invdist&smoothing=0&rval1=213&clr1=%232e9a58&rval2=250&clr2=%23b8ff85&rval3=300&clr3=%23f2ff0d&rval4=350&clr4=%23ffab4c&rval5=403&clr5=%23ff0000-->