MAP
IMAGETYPE png
MAXSIZE 4000
SIZE 800 800
SYMBOLSET "symbols.lst"
EXTENT -36387 5247099 384161 5628555
UNITS meters
WEB
   METADATA
      "ows_enable_request" "*"
      "wms_srs" "EPSG:900913 EPSG:4326 EPSG:3857"
      "labelcache_map_edge_buffer" "-10"
      "wms_title" "efficity price raster"
   END
END
DEBUG 1
CONFIG "MS_ERRORFILE" "stderr"
#CONFIG "PROJ_LIB" "/Users/nicolas/bin/mapserver-basemaps"
PROJECTION
   "init=epsg:3857"
END
OUTPUTFORMAT
  NAME "png"
  DRIVER AGG/PNG8
  MIMETYPE "image/png"
  IMAGEMODE RGB
  EXTENSION "png"
  TRANSPARENT FALSE
END

### Roads as google style
    include "roads_inc.map"

###### 93048 ############
    LAYER
       TYPE raster
       group "slope"
       STATUS ON
       name "price_93048"
       DEBUG 1
       PROCESSING "APPROXIMATION_SCALE=full"
       COMPOSITE
         OPACITY 100
       END

       PROJECTION
           "init=epsg:3857"
       END
       DATA "html-demo/data/price_grid1_clr_mask_93048.tif"
   END
###### 06088 ############
    LAYER
       TYPE raster
       group "slope"
       STATUS ON
       name "price_06088"
       DEBUG 1
       PROCESSING "APPROXIMATION_SCALE=full"
       COMPOSITE
         OPACITY 100
       END

       PROJECTION
           "init=epsg:3857"
       END
       DATA "html-demo/data/price_grid1_clr_mask_06088.tif"
    END

###### 35051 ############
    LAYER
       TYPE raster
       group "slope"
       STATUS ON
       name "price_35051"
       DEBUG 1
       PROCESSING "APPROXIMATION_SCALE=full"
       COMPOSITE
         OPACITY 100
       END

       PROJECTION
           "init=epsg:3857"
       END
       DATA "html-demo/data/price_grid1_clr_mask_35051.tif"
    END

###### masks ############
    LAYER
       TYPE raster
       group "slope"
       STATUS ON
       name "maskstr_93048"
       DEBUG 1
       PROCESSING "APPROXIMATION_SCALE=full"
       COMPOSITE
         OPACITY 100
       END

       PROJECTION
           "init=epsg:3857"
       END
       DATA "html-demo/data/price_grid1_clr_maskstr_93048.tif"
    END

    LAYER
       TYPE raster
       group "test"
       STATUS ON
       name "test"
       MASK "testmask"
       DEBUG 1
       PROCESSING "APPROXIMATION_SCALE=full"
       COMPOSITE
         COMPOP "multiply"
         OPACITY 100
         COMPFILTER "difference"
       END
       validation
            val1 ".*"
            val2 ".*"
            val3 ".*"
            val4 ".*"
            val5 ".*"
            val6 ".*"
            val7 ".*"
            val8 ".*"
            val9 ".*"
            val10 ".*"
            val11 ".*"
        end
        CLASSITEM "[pixel]"
        CLASS
          EXPRESSION ([pixel] <= %val1%)
          STYLE
            color 0 104 55
          END
        END
        CLASS
          EXPRESSION ([pixel] >= %val1% AND [pixel] < %val2%)
          STYLE
            color 26 152 80
          END
        END
        CLASS
          EXPRESSION ([pixel] >= %val2% AND [pixel] < %val3%)
          STYLE
            color 102 189 99
          END
        END
        CLASS
          EXPRESSION ([pixel] >= %val3% AND [pixel] < %val4%)
          STYLE
            color 166 217 106
          END
        END
        CLASS
          EXPRESSION ([pixel] >= %val4% AND [pixel] < %val5%)
          STYLE
            color 217 239 139
          END
        END
        CLASS
          EXPRESSION ([pixel] >= %val5% AND [pixel] < %val6%)
          STYLE
            color 255 255 191
          END
        END
        CLASS
          EXPRESSION ([pixel] >= %val6% AND [pixel] < %val7%)
          STYLE
            color 254 224 139
          END
        END
        CLASS
          EXPRESSION ([pixel] >= %val7% AND [pixel] < %val8%)
          STYLE
            color 253 174 97
          END
        END
        CLASS
          EXPRESSION ([pixel] >= %val8% AND [pixel] < %val9%)
          STYLE
            color 244 109 67
          END
        END
        CLASS
          EXPRESSION ([pixel] >= %val9% AND [pixel] < %val10%)
          STYLE
            color 215 48 39
          END
        END
        CLASS
          EXPRESSION ([pixel] >= %val10% )
          STYLE
            color 165 0 38
          END
        END

       PROJECTION
           "init=epsg:3857"
       END
       #DATA "html-demo/data/price_dem.tif"
       #DATA "/Volumes/GROSSD/tmp/price_dem.tif"
       DATA "/data_big2/Documents/geodata/price_dem.tif"
    END

    LAYER
       TYPE raster
       group "test2"
       STATUS ON
       name "test2"
       DEBUG 1
       PROCESSING "APPROXIMATION_SCALE=full"
       COMPOSITE
         OPACITY 100
       END

       PROJECTION
           "init=epsg:3857"
       END
       validation
           node_path ".*"
       end
       #DATA "/Volumes/GROSSD/tmp/priceeffi/rasterprice_%node_path%.tif"
       DATA "/data_big2/Documents/geodata/priceeffi/rasterprice_%node_path%.tif"
    END

    LAYER
       TYPE raster
       group "gdalgeo"
       STATUS ON
       name "gdalgeo"
       DEBUG 1
       PROCESSING "APPROXIMATION_SCALE=full"
       COMPOSITE
         OPACITY 100
       END

       PROJECTION
           "init=epsg:3857"
       END
       validation
           node_path ".*"
       end
       #DATA "/Volumes/GROSSD/tmp/priceeffi/gcrasterprice_%node_path%.tif"
       DATA "/data_big2/Documents/geodata/priceeffi/gcrasterprice_%node_path%.tif"
    END

    LAYER
        NAME "heatmap"
        TYPE raster
        CONNECTIONTYPE kerneldensity
        CONNECTION "obs_pts"
        STATUS on
        PROCESSING "RANGE_COLORSPACE=HSL"
        PROCESSING "KERNELDENSITY_RADIUS=20"
        PROCESSING "KERNELDENSITY_COMPUTE_BORDERS=ON"
        PROCESSING "KERNELDENSITY_NORMALIZATION=auto"
        # good
        #PROCESSING "KERNELDENSITY_NORMALIZATION=0.00015"
        OFFSITE 0 0 0
        CLASS
          STYLE
            #COLORRANGE  "#2D712Bff"  "#85262Aff"
            COLORRANGE  "#00FF00ff"  "#ff0000ff"
            DATARANGE 0 255
          END # STYLE
        END # CLASS
      END # LAYER



#    LAYER
#       TYPE raster
#       STATUS ON
#       group "slope"
#       name "hillshade"
#       DEBUG 1
#       PROCESSING "APPROXIMATION_SCALE=full"
#       COMPOSITE
#         OPACITY 30
#       END
#
#       PROJECTION
#           "init=epsg:3857"
#       END
#       DATA "html-demo/data/price_grid1_hillshade_93048.png"
#    END
#    LAYER
#       TYPE raster
#       STATUS ON
#       group "slope"
#       name "slopeshade"
#       DEBUG 1
#       PROCESSING "APPROXIMATION_SCALE=full"
#       COMPOSITE
#         OPACITY 30
#       END
#       PROJECTION
#           "init=epsg:3857"
#       END
#       DATA "html-demo/data/price_grid1_slopeshade_93048.tif"
#    END
#


############ other layers ###################

    layer
        type point
        status on
        name "obs_pts"
        CONNECTIONTYPE postgis
        connection "dbname=osm host=localhost port=5438 user=nicolas password=aimelerafting"
        PROJECTION
           "init=epsg:3857"
        END
        data "geom from (select point as geom, node_path::text, m2_price, mspixel from observations_for_carto where not is_outlier and node_path <@ '%node_path%' and code_insee = '44') as t using unique node_path using srid=3857"
        #data "html-demo/data/points.shp"
        validation
           node_path ".*"
        end

        CLASS
            style
                #color 34 34 34
                size [mspixel]
                #symbol "citycircle"
            end
        end
    end
    layer
        type point
        status on
        name "obs_pts_lbl"
        CONNECTIONTYPE postgis
        connection "dbname=osm host=localhost port=5438 user=nicolas password=aimelerafting"
        PROJECTION
           "init=epsg:3857"
        END
        data "geom from (select point as geom, node_path::text, m2_price from observations_for_carto where not is_outlier) as t using unique node_path using srid=3857"
        #data "html-demo/data/points.shp"
        labelitem "M2_PRICE"
        CLASS
            label
                size small
                color 0 0 0
            end
        end
    end
    layer
        type polygon
        status off
        name "testmask"
        CONNECTIONTYPE postgis
        connection "dbname=osm host=localhost port=5438 user=nicolas password=aimelerafting"
        PROJECTION
           "init=epsg:3857"
        END
        validation
            node_path ".*"
        end
        data "geom from (select id, st_transform(geomsimple_4326, 3857) as geom from administrative_boundaries where node_path='%node_path%') as t using unique id using srid=3857"
        class
            style
                color 0 0 0
            end
        end
    end
    # invalid communes
    layer
        type polygon
        status on
        name "invalidcom"
        CONNECTIONTYPE postgis
        connection "dbname=osm host=localhost port=5438 user=nicolas password=aimelerafting"
        PROJECTION
           "init=epsg:3857"
        END
        data "geom from (select id, st_transform(geomsimple_4326, 3857) as geom from administrative_boundaries a join admin_bound_values aa on a.node_path = aa.node_path where a.admin_level in (8,9) and not aa.valid) as t using unique id using srid=3857"
        class
            style
                color 200 200 180
                outlinecolor 80 80 60
            end
        end
    end
END
